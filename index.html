<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Whiteboard</title>
<style>
  *, *::before, *::after { box-sizing: border-box; }

  html, body {
    margin: 0;
    height: 100%;
    background: #f8f7f4;
    font-family: 'Segoe UI', system-ui, sans-serif;
    overflow: hidden;
  }

  #toolbar {
    position: fixed;
    top: 0; left: 0; right: 0;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 10px;
    background: #ffffff;
    border-bottom: 1px solid #e0ddd8;
    z-index: 20;
    height: 52px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  }

  .tool-group {
    display: flex;
    gap: 2px;
    padding: 0 4px;
    border-right: 1px solid #e0ddd8;
    margin-right: 4px;
  }
  .tool-group:last-child { border-right: none; }

  button {
    padding: 6px 10px;
    border: 1px solid transparent;
    background: transparent;
    cursor: pointer;
    border-radius: 5px;
    font-size: 13px;
    color: #444;
    transition: background 0.12s, border-color 0.12s;
    white-space: nowrap;
  }
  button:hover { background: #f0ede8; }
  button.active {
    background: #1a1a1a;
    color: #fff;
    border-color: #1a1a1a;
  }

  /* Stroke width */
  #strokeWidth {
    width: 60px;
    accent-color: #1a1a1a;
    cursor: pointer;
  }

  /* Color swatches */
  .color-swatch {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: transform 0.1s, border-color 0.1s;
    flex-shrink: 0;
  }
  .color-swatch:hover { transform: scale(1.15); }
  .color-swatch.active { border-color: #1a1a1a; transform: scale(1.1); }

  #colorPicker {
    width: 26px;
    height: 26px;
    border: 1px solid #ccc;
    border-radius: 50%;
    padding: 0;
    cursor: pointer;
    background: none;
    overflow: hidden;
  }
  #colorPicker::-webkit-color-swatch-wrapper { padding: 0; }
  #colorPicker::-webkit-color-swatch { border: none; border-radius: 50%; }

  /* Canvas */
  canvas {
    position: absolute;
    top: 52px;
    left: 0;
    cursor: crosshair;
  }

  /* Inline text editor */
  #textEditor {
    position: absolute;
    display: none;
    min-width: 80px;
    min-height: 24px;
    outline: none;
    border: 1.5px dashed #999;
    background: transparent;
    padding: 2px 4px;
    font-family: 'Segoe UI', system-ui, sans-serif;
    font-size: 16px;
    line-height: 1.4;
    color: #000;
    z-index: 15;
    cursor: text;
    white-space: pre;
    border-radius: 2px;
  }
</style>
</head>
<body>

<div id="toolbar">
  <!-- Drawing tools -->
  <div class="tool-group">
    <button data-tool="draw" class="active" title="Freehand (D)">‚úèÔ∏è Draw</button>
    <button data-tool="rect" title="Rectangle (R)">‚ñ≠ Rect</button>
    <button data-tool="circle" title="Circle (C)">‚óØ Circle</button>
    <button data-tool="arrow" title="Arrow (A)">‚Üí Arrow</button>
    <button data-tool="text" title="Text (T)">T Text</button>
  </div>

  <!-- Stroke width -->
  <div class="tool-group" style="align-items:center; gap:6px;">
    <span style="font-size:12px; color:#888;">Size</span>
    <input type="range" id="strokeWidth" min="1" max="20" value="2" title="Stroke width">
    <span id="strokeLabel" style="font-size:12px; color:#555; width:18px;">2</span>
  </div>

  <!-- Colors -->
  <div class="tool-group" style="align-items:center; gap:5px;">
    <div class="color-swatch active" style="background:#1a1a1a" data-color="#1a1a1a" title="Black"></div>
    <div class="color-swatch" style="background:#e63946" data-color="#e63946" title="Red"></div>
    <div class="color-swatch" style="background:#2196f3" data-color="#2196f3" title="Blue"></div>
    <div class="color-swatch" style="background:#4caf50" data-color="#4caf50" title="Green"></div>
    <div class="color-swatch" style="background:#ff9800" data-color="#ff9800" title="Orange"></div>
    <div class="color-swatch" style="background:#9c27b0" data-color="#9c27b0" title="Purple"></div>
    <input type="color" id="colorPicker" value="#1a1a1a" title="Custom color">
  </div>

  <!-- Actions -->
  <div class="tool-group">
    <button id="undo" title="Undo (Ctrl+Z)">‚Ü© Undo</button>
    <button id="clear" title="Clear all">üóë Clear</button>
  </div>
</div>

<canvas id="board"></canvas>
<div id="textEditor" contenteditable="true" spellcheck="false"></div>

<script>
/* ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const state = {
  tool: "draw",
  mode: "idle",
  color: "#1a1a1a",
  lineWidth: 2,
  history: [],
  currentStroke: null,
  startPoint: null,
  previewEnd: null,
};

const canvas   = document.getElementById("board");
const ctx      = canvas.getContext("2d");
const editor   = document.getElementById("textEditor");
const TOOLBAR  = 52;

/* ‚îÄ‚îÄ‚îÄ Resize ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function resize() {
  // Save history snapshot as image to avoid clearing on resize
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight - TOOLBAR;
  render();
}
window.addEventListener("resize", resize);
resize();

/* ‚îÄ‚îÄ‚îÄ Toolbar: tools ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.querySelectorAll("[data-tool]").forEach(btn => {
  btn.addEventListener("click", () => {
    commitTextEditor();
    document.querySelectorAll("[data-tool]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    state.tool = btn.dataset.tool;
    state.mode = "idle";
    canvas.style.cursor = state.tool === "text" ? "text" : "crosshair";
    render();
  });
});

/* ‚îÄ‚îÄ‚îÄ Toolbar: stroke width ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const strokeInput = document.getElementById("strokeWidth");
const strokeLabel = document.getElementById("strokeLabel");
strokeInput.addEventListener("input", () => {
  state.lineWidth = parseInt(strokeInput.value);
  strokeLabel.textContent = strokeInput.value;
});

/* ‚îÄ‚îÄ‚îÄ Toolbar: color swatches ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.querySelectorAll(".color-swatch").forEach(sw => {
  sw.addEventListener("click", () => {
    setColor(sw.dataset.color);
    document.querySelectorAll(".color-swatch").forEach(s => s.classList.remove("active"));
    sw.classList.add("active");
    document.getElementById("colorPicker").value = sw.dataset.color;
  });
});

const colorPicker = document.getElementById("colorPicker");
colorPicker.addEventListener("input", () => {
  setColor(colorPicker.value);
  document.querySelectorAll(".color-swatch").forEach(s => s.classList.remove("active"));
});

function setColor(c) {
  state.color = c;
  if (editor.style.display !== "none") editor.style.color = c;
}

/* ‚îÄ‚îÄ‚îÄ Toolbar: undo / clear ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.getElementById("undo").onclick = () => { state.history.pop(); render(); };
document.getElementById("clear").onclick = () => {
  state.history = [];
  state.mode = "idle";
  hideTextEditor();
  render();
};

/* ‚îÄ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener("keydown", e => {
  if (editor.style.display !== "none" && e.key !== "Escape") return;
  if ((e.ctrlKey || e.metaKey) && e.key === "z") { e.preventDefault(); state.history.pop(); render(); return; }
  if (e.key === "Escape") { commitTextEditor(); return; }
  const map = { d:"draw", r:"rect", c:"circle", a:"arrow", t:"text" };
  if (map[e.key]) {
    document.querySelectorAll("[data-tool]").forEach(b => b.classList.remove("active"));
    document.querySelector(`[data-tool="${map[e.key]}"]`).classList.add("active");
    state.tool = map[e.key];
    canvas.style.cursor = state.tool === "text" ? "text" : "crosshair";
  }
});

/* ‚îÄ‚îÄ‚îÄ Canvas input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
canvas.addEventListener("mousedown", e => {
  commitTextEditor();
  const x = e.offsetX, y = e.offsetY;

  if (state.tool === "text") {
    showTextEditor(x, y);
    return;
  }

  state.mode = "drawing";
  state.startPoint = { x, y };
  state.previewEnd = { x, y };

  if (state.tool === "draw") {
    state.currentStroke = [{ x, y }];
    state.history.push({ type: "draw", points: state.currentStroke, color: state.color, lw: state.lineWidth });
  }
});

canvas.addEventListener("mousemove", e => {
  if (state.mode !== "drawing") return;
  const x = e.offsetX, y = e.offsetY;

  if (state.tool === "draw") {
    state.currentStroke.push({ x, y });
  } else {
    state.previewEnd = { x, y };
  }
  render();
});

canvas.addEventListener("mouseup", e => {
  if (state.mode !== "drawing") return;
  const x = e.offsetX, y = e.offsetY;

  if (state.tool !== "draw") {
    const { startPoint: s } = state;
    if (Math.abs(x - s.x) > 2 || Math.abs(y - s.y) > 2) {
      state.history.push({ type: state.tool, x1: s.x, y1: s.y, x2: x, y2: y, color: state.color, lw: state.lineWidth });
    }
  }

  state.mode = "idle";
  state.currentStroke = null;
  state.previewEnd = null;
  render();
});

// Cancel drag if mouse leaves canvas
canvas.addEventListener("mouseleave", () => {
  if (state.mode === "drawing" && state.tool !== "draw") {
    state.mode = "idle";
    state.previewEnd = null;
    render();
  }
});

/* ‚îÄ‚îÄ‚îÄ Inline text editor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function showTextEditor(x, y) {
  editor.style.left   = (x) + "px";
  editor.style.top    = (y + TOOLBAR) + "px";
  editor.style.color  = state.color;
  editor.style.fontSize = Math.max(state.lineWidth * 4, 14) + "px";
  editor.style.display = "block";
  editor.innerHTML = "";
  editor.focus();
  state.mode = "placingText";
}

function commitTextEditor() {
  if (editor.style.display === "none") return;
  const text = editor.innerText.trim();
  if (text) {
    const x = parseInt(editor.style.left);
    const y = parseInt(editor.style.top) - TOOLBAR;
    const fs = parseInt(editor.style.fontSize);
    state.history.push({ type: "text", x, y: y + fs, text, color: state.color, lw: state.lineWidth, fontSize: fs });
  }
  hideTextEditor();
  render();
}

function hideTextEditor() {
  editor.style.display = "none";
  editor.innerHTML = "";
  state.mode = "idle";
}

editor.addEventListener("keydown", e => {
  if (e.key === "Escape") commitTextEditor();
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); commitTextEditor(); }
});

/* ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw committed history
  state.history.forEach(item => drawItem(ctx, item));

  // Draw ghost preview
  if (state.mode === "drawing" && state.previewEnd && state.tool !== "draw") {
    const { startPoint: s, previewEnd: e } = state;
    ctx.save();
    ctx.globalAlpha = 0.45;
    ctx.strokeStyle = state.color;
    ctx.fillStyle   = state.color;
    ctx.lineWidth   = state.lineWidth;
    ctx.setLineDash([5, 4]);
    drawShape(ctx, state.tool, s.x, s.y, e.x, e.y);
    ctx.restore();
  }
}

function drawItem(ctx, item) {
  ctx.save();
  ctx.strokeStyle = item.color || "#1a1a1a";
  ctx.fillStyle   = item.color || "#1a1a1a";
  ctx.lineWidth   = item.lw   || 2;
  ctx.setLineDash([]);

  if (item.type === "draw") {
    ctx.beginPath();
    item.points.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
    ctx.lineJoin = "round";
    ctx.lineCap  = "round";
    ctx.stroke();
  } else if (item.type === "text") {
    ctx.font = `${item.fontSize || 16}px 'Segoe UI', system-ui, sans-serif`;
    const lines = item.text.split("\n");
    const lh = (item.fontSize || 16) * 1.4;
    lines.forEach((l, i) => ctx.fillText(l, item.x, item.y + i * lh));
  } else {
    drawShape(ctx, item.type, item.x1, item.y1, item.x2, item.y2);
  }
  ctx.restore();
}

function drawShape(ctx, type, x1, y1, x2, y2) {
  if (type === "rect") {
    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
  } else if (type === "circle") {
    const r = Math.hypot(x2 - x1, y2 - y1);
    ctx.beginPath();
    ctx.arc(x1, y1, r, 0, Math.PI * 2);
    ctx.stroke();
  } else if (type === "arrow") {
    drawArrow(ctx, x1, y1, x2, y2);
  }
}

function drawArrow(ctx, x1, y1, x2, y2) {
  const angle = Math.atan2(y2 - y1, x2 - x1);
  const head  = Math.max(ctx.lineWidth * 4, 10);
  ctx.beginPath();
  ctx.moveTo(x1, y1);
  ctx.lineTo(x2, y2);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.beginPath();
  ctx.moveTo(x2, y2);
  ctx.lineTo(x2 - head * Math.cos(angle - Math.PI / 6), y2 - head * Math.sin(angle - Math.PI / 6));
  ctx.lineTo(x2 - head * Math.cos(angle + Math.PI / 6), y2 - head * Math.sin(angle + Math.PI / 6));
  ctx.closePath();
  ctx.fill();
}
</script>
</body>
</html>
